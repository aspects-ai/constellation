# ConstellationFS Remote Backend Service
# Docker Compose configuration for easy deployment

services:
  remote-backend:
    build:
      context: ..
      dockerfile: remote/Dockerfile.runtime
    image: constellationfs/remote-backend:latest
    container_name: constellation-remote-backend
    ports:
      - "2222:22"   # SSH port mapping
      - "3001:3001" # MCP server port
    volumes:
      - ./workspace:/workspace  # Persistent workspace
      # - ./keys:/keys:ro        # SSH keys (uncomment if needed)
    environment:
      # Storage configuration
      # STORAGE_TYPE: 'local' (default) or 'archil'
      - STORAGE_TYPE=local

      # Archil configuration (required when STORAGE_TYPE=archil)
      # - ARCHIL_API_KEY=your-archil-api-key
      # - ARCHIL_BUCKET=user@bucket-name
      # - ARCHIL_REGION=gcp-us-central1
      # - ARCHIL_MOUNT_PATH=/workspace

      # Multi-user configuration (comma-separated)
      - SSH_USERS=dev:devpassword,admin:adminpassword

      # Workspace configuration
      - WORKSPACE_ROOT=/workspace
      - ENABLE_LOGGING=true

      # MCP server configuration
      - MCP_PORT=3001
      - MCP_AUTH_TOKEN=your-secure-auth-token  # Change this!

      # SSH key configuration (optional)
      # - SSH_PUBLIC_KEY=ssh-rsa AAAAB3N...your-key-here
    
    devices:
      - /dev/fuse:/dev/fuse
    
    cap_add:
      - SYS_ADMIN
    
    security_opt:
      - apparmor:unconfined
    
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "service", "ssh", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

# Optional: Create a development network
networks:
  constellation:
    driver: bridge

# Optional: Named volume for workspace persistence
volumes:
  workspace:
    driver: local